name: postal
version: 1.0.0
description: Postal mail server application

resources:
  cpu: "500m"
  memory: "512Mi"

replicas: 1
# ===============================
# INIT CONTAINER
# ===============================
initContainers:
  - name: postal-init
    image: ghcr.io/nawfalrakhmansah/postal-app:latest
    imagePullPolicy: Always
    command:
      - sh
      - -c
      - |
        until nc -z postgres.postal.svc.cluster.local 5432; do
          echo "Waiting for PostgreSQL..."
          sleep 5
        done
        postal initialize
    env:
      - name: POSTGRES_HOST
        value: postgres.postal.svc.cluster.local
      - name: POSTGRES_PORT
        value: "5432"
      - name: POSTGRES_USER
        value: postal_user
      - name: POSTGRES_PASSWORD
        value: ${POSTGRES_PASSWORD}
      - name: POSTGRES_DB
        value: postal_db

# ===============================
# MAIN CONTAINER
# ===============================
container:
  image: ghcr.io/nawfalrakhmansah/postal-app:latest
  imagePullPolicy: Always
  command: ["postal", "web-server"]
  port: 3000

  env:
    - name: NODE_ENV
      value: production
    - name: POSTGRES_HOST
      value: postgres.postal.svc.cluster.local
    - name: POSTGRES_PORT
      value: "5432"
    - name: POSTGRES_USER
      value: postal_user
    - name: POSTGRES_PASSWORD
      value: ${POSTGRES_PASSWORD}
    - name: POSTGRES_DB
      value: postal_db

# ===============================
# DATABASE
# ===============================
dependencies:
  - type: POSTGRES
    name: postgres
    version: "15"

# ===============================
# GHCR PRIVATE IMAGE
# ===============================
imagePullSecrets:
  - name: ghcr-secret

# ===============================
# DOMAIN
# ===============================
domain: postal.deployaja.id
